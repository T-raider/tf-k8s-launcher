---
# tasks file for k8s_master_conf
- name: "Installing docker"
  ansible.builtin.package:
    name: "docker"
    state: present

- name: "Starting and enabling docker"
  ansible.builtin.service:
    enabled: true
    name: "docker"
    state: started

- name: "Configuring yum for kubeadm"
  ansible.builtin.yum_repository:
    name: "kubernetes"
    description: "repo for kubernetes"
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
    enabled: true
    repo_gpgcheck: true
    gpgcheck: true
    gpgkey:
      - "https://packages.cloud.google.com/yum/doc/yum-key.gpg"
      - "https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg"

- name: "Installing kubelet, kubeadm & kubectl"
  ansible.builtin.yum:
    name: "{{ item.package_name }}"
    disable_excludes: "kubernetes"
    state: present

  loop:
    - { package_name: "kubelet" }
    - { package_name: "kubeadm" }
    - { package_name: "kubectl" }

- name: "Starting and enabling kubelet"
  ansible.builtin.service:
    enabled: true
    name: "kubelet"
    state: started

- name: "Pulling images ..."
  ansible.builtin.command:
    cmd: "kubeadm config images pull"
  changed_when: false

- name: "Creating daemon.js"
  ansible.builtin.file:
    path: "/etc/docker/daemon.js"
    state: touch
    mode: u=rwx,g=rwx,o=rwx

- name: "Changing docker driver to systemd"
  ansible.builtin.blockinfile:
    path: "/etc/docker/daemon.js"
    block: |
      {
      "exec-opts":["native.cgroupdriver=systemd"]
      }
    state: present

- name: "Restarting docker"
  ansible.builtin.service:
    name: "docker"
    state: restarted

- name: "Installing iproute-tc"
  ansible.builtin.package:
    name: "iproute-tc"
    state: present

- name: "Configuring bridge-nf-call-iptables"
  ansible.builtin.lineinfile:
    path: "/proc/sys/net/bridge/bridge-nf-call-iptables"
    line: "1"
    state: present

- name: "Initializing ..."
  ansible.builtin.command:
    cmd: "{{ item.command }}"

  loop:
    - { command: "kubeadm init --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=NumCPU --ignore-preflight-errors=Mem" }
    - { command: "mkdir -p $HOME/.kube" }
    - { command: "sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config" }

  changed_when: false

- name: "Changing permissions for .kube/config"
  ansible.builtin.file:
    path: $HOME/.kube/config
    owner: "{{ ansible_effective_user_id }}"
    group: "{{ ansible_effective_group_id }}"
    mode: 0644

- name: "Creating cluster join token file"
  ansible.builtin.command:
    cmd: "{{ item.command }}"

  loop:
    - { command: "kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml" }
    - { command: "kubeadm token create --print-join-command > token_file.txt" }

  changed_when: false

- name: "Fetching cluster join token file"
  ansible.builtin.fetch:
    src: "/home/ec2-user/token_file.txt"
    dest: "../"
    flat: true
